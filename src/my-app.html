<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="my-icons.html">

<dom-module id="my-app">
	<template>
		<style>
			:host {
				display: block;
				--app-primary-color: #4285f4;
				--app-secondary-color: black;
			}

			app-header {
				background-color: var(--app-primary-color);
				color: #fff;
			}
			app-header paper-icon-button {
				--paper-icon-button-ink-color: white;
			}

			.drawer-list {
				margin: 0 20px;
			}
			.drawer-list a {
				display: block;
				padding: 0 16px;
				line-height: 40px;
				text-decoration: none;
				color: var(--app-secondary-color);
			}
			.drawer-list a.iron-selected {
				color: black;
				font-weight: bold;
			}
			.drawer-list a.subroute {
				padding-left: 32px;
			}
		</style>

		<app-location route="{{rootRoute}}"></app-location>
		<app-route
				route="{{rootRoute}}"
				pattern="/:lang"
				data="{{rootRouteData}}"
				tail="{{rootRouteTail}}"></app-route>

		<app-drawer-layout fullbleed>
			<!-- Drawer content -->
			<app-drawer>
				<app-toolbar>Menu</app-toolbar>
				<iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
					<template is="dom-repeat" items="[[pages]]">
						<a name="[[item]]" href="/[[language]]/[[item]]">[[localizePageName(item)]]</a>
					</template>
			</app-drawer>

			<!-- Main content -->
			<app-header-layout has-scrolling-region>
				<app-header condenses reveals effects="waterfall">
					<app-toolbar>
						<paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
						<div main-title>[[localize('name')]]</div>
						<!-- TODO: create language switcher -->
					</app-toolbar>
				</app-header>

				<app-route
					route="{{rootRouteTail}}"
					pattern="/:page"
					data="{{pageRouteData}}"></app-route>

				<iron-pages selected="[[page]]" attr-for-selected="name" fallback-selection="e404" role="main">
					<page-home language="[[language]]" name="home"></page-home>
					<page-project language="[[language]]" name="project"></page-project>
					<page-team language="[[language]]" name="team"></page-team>
					<page-contact language="[[language]]" name="contact"></page-contact>
					<page-e404 language="[[language]]" name="e404"></page-e404>
				</iron-pages>
			</app-header-layout>
		</app-drawer-layout>
	</template>

	<script>
		// Check validity of localStorage language before trying to use it
		if(localStorage.language !== 'en' && localStorage.language !== 'pt' && !!localStorage.language) {
			localStorage.removeItem('language')
		}

		Polymer({
			is: 'my-app',
			behaviors: [App.LocalizeBehavior],
			properties: {
				rootRoute: Object,
				rootRouteData: Object,
				rootRouteTail: Object,
				pageRouteData: Object,
				pages: {
					type: Array,
					value: ['home', 'project', 'team', 'contact']
				},
				localizePageName: {
					type: Function,
					computed: '_computeLocalizePageName(localize)'
				},
				page: {
					type: String,
					observer: '_pageChanged'
				}
			},
			observers: [
				'_rootRouteChanged(rootRouteData.lang)',
				'_languageChanged(language)',
				'_pageRouteChanged(pageRouteData.page)'
			],
			_computeLocalizePageName(localize) {
				return page => localize('page.'+page)
			},
			_rootRouteChanged(language) {
				if(this._isLangInvalid(language)) {
					this.rootRouteData.lang = localStorage.language || (navigator.language.includes('pt') ? 'pt' : 'en')
					language = this.rootRouteData.lang
				}

				this.language = language
			},
			_languageChanged(language) {
				// Save language preference
				localStorage.language = language
			},
			_isLangInvalid(lang) {
				return !(lang === 'en' || lang === 'pt')
			},
			_pageRouteChanged(page) {
				if (!page || page === '') {
					this.set('pageRouteData.page', 'home')
					return
				}

				if (this.page !== page) this.page = page 

				// Load page import on demand. Show 404 page if fails
				this._loadPage(page)
			},
			_pageChanged(page) {
				// Don't ruin the trickery with e404, and don't set the same thing twice
				if (this.pageRouteData.page === page || page === 'e404') return
				this.set('pageRouteData.page', page)
			},
			_loadPage(page) {
				const resolvedPageUrl = this.resolveUrl('pages/page-' + page + '.html')
				this.importHref(resolvedPageUrl, null, this._showPage404, true)
			},
			_showPage404() {
				// Keep current URL
				this.page = 'e404'
				this._loadPage('e404')
			}
		})
	</script>
</dom-module>
